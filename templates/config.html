<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - ICS Sensor Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #121212;
            --bg-card: #1c1c1e;
            --bg-elevated: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --accent-primary: #007aff;
            --accent-secondary: #5ac8fa;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --error-color: #ff3b30;
            --card-border-radius: 12px;
            --input-border-radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            --transition-speed: 0.3s;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(145deg, var(--bg-primary), var(--bg-secondary));
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-attachment: fixed;
        }

        .container {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        /* Navbar styling */
        .navbar {
            background-color: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1rem;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--text-primary) !important;
            letter-spacing: -0.5px;
        }

        .navbar-dark .navbar-nav .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        .navbar-dark .navbar-nav .nav-link:hover,
        .navbar-dark .navbar-nav .active .nav-link {
            color: var(--text-primary);
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Status indicators */
        .status-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: var(--card-border-radius);
            background-color: var(--bg-card);
            flex: 1;
            min-width: 220px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .status-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            margin-right: 12px;
            border-radius: 50%;
            background-color: var(--success-color);
            color: var(--bg-card);
        }

        .status-icon.error {
            background-color: var(--error-color);
        }

        .status-icon i {
            font-size: 12px;
        }

        .status-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        /* Form sections */
        h1, h2, h3, h4 {
            color: var(--text-primary);
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 1.4rem;
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
        }

        h2 i {
            margin-right: 0.75rem;
            color: var(--accent-primary);
        }

        h3 {
            font-size: 1.2rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        h4 {
            font-size: 1.1rem;
            color: var(--accent-primary);
            margin-top: 0;
            margin-bottom: 1rem;
        }

        h2 .badge {
            margin-left: 0.75rem;
            font-size: 0.7rem;
            padding: 0.4rem 0.5rem;
            vertical-align: middle;
        }

        .form-section {
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--card-border-radius);
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .form-section h2:first-child {
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control {
            background-color: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--input-border-radius);
            padding: 0.65rem 0.85rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-control:focus {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-primary);
            color: var(--text-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 16px;
            padding-right: 2.5rem;
            color: var(--text-primary);
        }

        /* Fix for dropdown styling */
        select.form-control option {
            background-color: var(--bg-elevated);
            color: white;
            padding: 10px;
        }

        /* Override browser default styling for select dropdowns */
        @-moz-document url-prefix() {
            select.form-control {
                color: white;
                background-color: var(--bg-elevated);
            }
            select.form-control option {
                background-color: var(--bg-card);
            }
        }

        /* Webkit browsers (Chrome, Safari) */
        select.form-control::-webkit-listbox {
            background-color: var(--bg-card);
            color: white;
        }

        /* Custom styling for the receiver type dropdown specifically */
        #receiver_type {
            font-weight: 500;
            color: white;
            background-color: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: auto;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            white-space: normal;
            text-overflow: clip;
            overflow: visible;
            min-height: 45px;
        }

        /* Improve contrast for dropdown items */
        select.form-control option:hover,
        select.form-control option:checked,
        select.form-control option:focus {
            background-color: var(--accent-primary);
            color: white;
        }

        .btn {
            font-weight: 600;
            padding: 0.65rem 1.25rem;
            border-radius: var(--input-border-radius);
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(to right, var(--accent-secondary), var(--accent-primary));
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(to right, #34c759, #30d158);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-success:hover {
            background: linear-gradient(to right, #30d158, #34c759);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background-color: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background-color: var(--bg-elevated);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        /* Spinner animation */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            display: inline-block;
            margin-left: 0.5rem;
            animation: spin 1s linear infinite;
        }

        .spinner.hidden {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Small text */
        small {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: block;
            margin-top: 0.5rem;
        }

        small i {
            margin-right: 0.5rem;
        }

        /* Section dividers */
        .section-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent);
            margin: 1.5rem 0;
        }

        /* Badge styles */
        .badge-warning {
            background-color: var(--warning-color);
            color: var(--bg-primary);
            font-weight: 600;
        }

        /* Save status */
        #save-status {
            display: inline-block;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #save-status.visible {
            opacity: 1;
        }

        /* Checkbox styling */
        .custom-control-input:checked ~ .custom-control-label::before {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .custom-control-label::before {
            background-color: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .custom-control-label::after {
            background-color: transparent;
        }

        .card {
            background-color: var(--bg-elevated);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--card-border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* Test button styling */
        .btn-test {
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
            border-radius: var(--input-border-radius);
            background-color: rgba(0, 122, 255, 0.2);
            color: var(--accent-primary);
            border: 1px solid rgba(0, 122, 255, 0.3);
            transition: all 0.2s ease;
        }

        .btn-test:hover {
            background-color: rgba(0, 122, 255, 0.3);
            color: white;
        }

        /* Receiver section styles */
        .receiver-section {
            padding: 1rem;
            background-color: var(--bg-elevated);
            border-radius: var(--card-border-radius);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .primary-receiver {
            border-left: 4px solid var(--accent-primary);
            position: relative;
        }

        .primary-receiver::before {
            content: "Primary";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--accent-primary);
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background-color: var(--bg-elevated);
            color: var(--text-primary);
            border-radius: var(--card-border-radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            overflow: hidden;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-header {
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toast-body {
            padding: 0.75rem;
        }

        .toast-header .close {
            color: var(--text-primary);
            opacity: 0.7;
            font-size: 1.5rem;
            font-weight: 700;
            padding: 0;
            margin-left: 0.5rem;
        }

        .toast-header .close:hover {
            opacity: 1;
        }

        .toast.success .toast-header {
            background-color: rgba(52, 199, 89, 0.2);
            color: var(--success-color);
            border-bottom: 1px solid rgba(52, 199, 89, 0.3);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error .toast-header {
            background-color: rgba(255, 59, 48, 0.2);
            color: var(--error-color);
            border-bottom: 1px solid rgba(255, 59, 48, 0.3);
        }

        .toast.error {
            border-left: 4px solid var(--error-color);
        }

        .toast.warning .toast-header {
            background-color: rgba(255, 149, 0, 0.2);
            color: var(--warning-color);
            border-bottom: 1px solid rgba(255, 149, 0, 0.3);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }

        /* Test Results Styling */
        .test-result-container {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: var(--card-border-radius);
            background-color: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .test-result-item {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--input-border-radius);
            background-color: var(--bg-elevated);
            border-left: 4px solid transparent;
        }

        .test-result-item.success {
            border-left-color: var(--success-color);
        }

        .test-result-item.warning {
            border-left-color: var(--warning-color);
        }

        .test-result-item.error {
            border-left-color: var(--error-color);
        }

        .test-result-item h5 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .test-result-item p {
            margin-bottom: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* User Management Section */
        .user-management {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: var(--bg-card);
            border-radius: var(--card-border-radius);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .user-management h3 {
            display: flex;
            align-items: center;
            font-size: 1.3rem;
            margin-bottom: 1.25rem;
        }

        .user-management h3 i {
            margin-right: 0.75rem;
            color: var(--accent-primary);
        }

        /* Validation styles */
        .invalid-feedback {
            display: none;
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .was-validated .form-control:invalid {
            border-color: var(--error-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 59, 48, 0.25);
        }

        .was-validated .form-control:invalid ~ .invalid-feedback {
            display: block;
        }

        /* Accordion styling */
        .config-accordion {
            margin-bottom: 1.5rem;
        }

        .accordion-header {
            background-color: var(--bg-card);
            padding: 1rem 1.25rem;
            border-radius: var(--card-border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .accordion-header:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .accordion-header h3 {
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .accordion-header h3 i {
            margin-right: 0.75rem;
            color: var(--accent-primary);
            width: 20px;
            text-align: center;
        }

        .accordion-header .toggle-icon {
            transition: transform 0.3s ease;
        }

        .accordion-header.active .toggle-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            background-color: var(--bg-card);
            padding: 1.25rem;
            border-radius: var(--card-border-radius);
            margin-bottom: 1rem;
            display: none;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .accordion-content.active {
            display: block;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .status-container {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">ICS Sensor Dashboard</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Dashboard</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="{{ url_for('config') }}">Configuration <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>System Configuration</h1>

        <!-- Toast container for notifications -->
        <div class="toast-container" id="toast-container"></div>

        <!-- Status Section with Action Buttons -->
        <div class="form-section">
            <h2><i class="fas fa-heart-pulse"></i> Connection Status</h2>

            <!-- Status Indicators -->
            <div class="status-container">
                <div class="status-indicator">
                    <div class="status-icon" id="yolink-status-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="status-text" id="yolink-mqtt-message">YoLink MQTT connection is active.</div>
                </div>

                <div class="status-indicator">
                    <div class="status-icon" id="monitor-status-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="status-text" id="monitor-mqtt-message">Monitor MQTT connection is active.</div>
                </div>

                <div class="status-indicator">
                    <div class="status-icon" id="receiver-status-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="status-text" id="receiver-message">MODBUS Receiver Connected</div>
                </div>

                <div class="status-indicator">
                    <div class="status-icon" id="modbus-status-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="status-text" id="modbus-message">Modbus Relay Connected</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="refresh-devices-btn" class="btn btn-success">
                    <i class="fas fa-sync-alt"></i> Refresh YoLink Devices
                </button>
                <button id="restart-services-btn" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> Restart Services
                </button>
            </div>

            <div id="refresh-status" class="mt-2 mb-0 text-center" style="min-height: 24px;">
                <span id="refresh-message"></span>
                <span id="refresh-spinner" class="spinner hidden"></span>
            </div>
        </div>

        <!-- Configuration Form -->
        <form id="config-form" class="needs-validation" method="POST" action="{{ url_for('config') }}" novalidate>
            <!-- Configuration Accordion -->
            <div class="config-accordion">
                <!-- YoLink Configuration -->
                <div class="accordion-header" data-target="yolink-config">
                    <h3><i class="fas fa-link"></i> YoLink Configuration</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="accordion-content active" id="yolink-config">
                    <div class="form-group">
                        <label for="yolink_uaid">YoLink UAID</label>
                        <input type="text" id="yolink_uaid" name="yolink_uaid" class="form-control" value="{{ config.yolink.uaid|default('') }}" required>
                        <div class="invalid-feedback">YoLink UAID is required</div>
                    </div>
                    <div class="form-group">
                        <label for="yolink_secret_key">YoLink Secret Key</label>
                        <input type="password" id="yolink_secret_key" name="yolink_secret_key" class="form-control" value="{{ config.yolink.secret_key|default('') }}" required>
                        <div class="invalid-feedback">YoLink Secret Key is required</div>
                    </div>
                    <div class="form-group">
                        <label for="yolink_url">YoLink MQTT URL</label>
                        <input type="text" id="yolink_url" name="yolink_url" class="form-control" value="{{ config.mqtt.url|default('mqtt://api.yosmart.com') }}" required>
                        <div class="invalid-feedback">YoLink MQTT URL is required</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yolink_port">YoLink MQTT Port</label>
                                <input type="number" id="yolink_port" name="yolink_port" class="form-control" value="{{ config.mqtt.port|default(8003) }}" min="1" max="65535" required>
                                <div class="invalid-feedback">Port must be between 1-65535</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yolink_topic">YoLink MQTT Topic</label>
                                <input type="text" id="yolink_topic" name="yolink_topic" class="form-control" value="{{ config.mqtt.topic|default('yl-home/${Home ID}/+/report') }}" required>
                                <div class="invalid-feedback">MQTT Topic is required</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monitor MQTT Configuration -->
                <div class="accordion-header" data-target="monitor-config">
                    <h3><i class="fas fa-broadcast-tower"></i> Monitor MQTT Configuration</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="accordion-content" id="monitor-config">
                    <div class="form-group">
                        <label for="monitor_mqtt_url">Monitor MQTT URL</label>
                        <input type="text" id="monitor_mqtt_url" name="monitor_mqtt_url" class="form-control" value="{{ config.mqtt_monitor.url|default('mqtt://monitor.industrialcamera.com') }}" required>
                        <div class="invalid-feedback">Monitor MQTT URL is required</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="monitor_mqtt_port">Monitor MQTT Port</label>
                                <input type="number" id="monitor_mqtt_port" name="monitor_mqtt_port" class="form-control" value="{{ config.mqtt_monitor.port|default(1883) }}" min="1" max="65535" required>
                                <div class="invalid-feedback">Port must be between 1-65535</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="monitor_mqtt_username">Username</label>
                                <input type="text" id="monitor_mqtt_username" name="monitor_mqtt_username" class="form-control" value="{{ config.mqtt_monitor.username|default('') }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="monitor_mqtt_password">Password</label>
                                <input type="password" id="monitor_mqtt_password" name="monitor_mqtt_password" class="form-control" value="{{ config.mqtt_monitor.password|default('') }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Receiver Configuration -->
                <div class="accordion-header" data-target="receiver-config">
                    <h3><i class="fas fa-radio"></i> Receiver Configuration</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="accordion-content" id="receiver-config">
                    <div class="form-group">
                        <label for="receiver_type">Primary Receiver Type</label>
                        <select id="receiver_type" name="receiver_type" class="form-control" required>
                            <option value="CHEKT" {% if config.receiver_type == 'CHEKT' %}selected{% endif %}>CHEKT</option>
                            <option value="SIA" {% if config.receiver_type == 'SIA' %}selected{% endif %}>SIA</option>
                            <option value="MODBUS" {% if config.receiver_type == 'MODBUS' %}selected{% endif %}>Modbus Relay</option>
                        </select>
                        <small><i class="fas fa-info-circle"></i> Select your primary receiver type. This determines which receiver gets events by default.</small>
                    </div>

                    <!-- CHEKT Configuration -->
                    <div class="receiver-section mt-4" id="chekt-section">
                        <h4>CHEKT Receiver</h4>
                        <div class="custom-control custom-switch mb-3">
                            <input type="checkbox" class="custom-control-input" id="chekt_enabled" name="chekt_enabled" {% if config.chekt.get('enabled', True) %}checked{% endif %}>
                            <label class="custom-control-label" for="chekt_enabled">Enable CHEKT Receiver</label>
                        </div>
                        <div id="chekt-config" class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-md-0">
                                        <label for="chekt_api_token">CHEKT API Token</label>
                                        <input type="text" id="chekt_api_token" name="chekt_api_token" class="form-control" value="{{ config.chekt.api_token|default('') }}">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-md-0">
                                        <label for="chekt_ip">Receiver IP</label>
                                        <input type="text" id="chekt_ip" name="chekt_ip" class="form-control" value="{{ config.chekt.ip|default('') }}">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-0">
                                        <label for="chekt_port">Port</label>
                                        <input type="number" id="chekt_port" name="chekt_port" class="form-control" value="{{ config.chekt.port|default(30003) }}" min="1" max="65535">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SIA Configuration -->
                    <div class="receiver-section mt-3" id="sia-section">
                        <h4>SIA Receiver</h4>
                        <div class="custom-control custom-switch mb-3">
                            <input type="checkbox" class="custom-control-input" id="sia_enabled" name="sia_enabled" {% if config.sia.get('enabled', False) %}checked{% endif %}>
                            <label class="custom-control-label" for="sia_enabled">Enable SIA Receiver</label>
                        </div>
                        <div id="sia-config" class="mt-3" {% if not config.sia.get('enabled', False) %}style="opacity: 0.5;"{% endif %}>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="sia_ip">SIA IP</label>
                                        <input type="text" id="sia_ip" name="sia_ip" class="form-control" value="{{ config.sia.ip|default('') }}" {% if not config.sia.get('enabled', False) %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="sia_port">SIA Port</label>
                                        <input type="number" id="sia_port" name="sia_port" class="form-control" value="{{ config.sia.port|default('') }}" min="1" max="65535" {% if not config.sia.get('enabled', False) %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="sia_account_id">Account ID</label>
                                        <input type="text" id="sia_account_id" name="sia_account_id" class="form-control" value="{{ config.sia.account_id|default('') }}" {% if not config.sia.get('enabled', False) %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="sia_transmitter_id">Transmitter ID</label>
                                        <input type="text" id="sia_transmitter_id" name="sia_transmitter_id" class="form-control" value="{{ config.sia.transmitter_id|default('') }}" {% if not config.sia.get('enabled', False) %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-0">
                                        <label for="sia_encryption_key">Encryption Key</label>
                                        <input type="text" id="sia_encryption_key" name="sia_encryption_key" class="form-control" value="{{ config.sia.encryption_key|default('') }}" {% if not config.sia.get('enabled', False) %}disabled{% endif %}>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modbus Relay Configuration -->
                    <div class="receiver-section mt-3" id="modbus-section">
                        <h4>Modbus Relay</h4>
                        <div class="custom-control custom-switch mb-3">
                            <input type="checkbox" class="custom-control-input" id="modbus_enabled" name="modbus_enabled" {% if config.modbus.enabled %}checked{% endif %}>
                            <label class="custom-control-label" for="modbus_enabled">Enable Modbus Relay</label>
                        </div>
                        <div id="modbus-config" class="mt-3" {% if not config.modbus.enabled %}style="opacity: 0.5;"{% endif %}>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="modbus_ip">Relay IP Address</label>
                                        <input type="text" id="modbus_ip" name="modbus_ip" class="form-control" value="{{ config.modbus.ip|default('') }}" placeholder="192.168.1.100" {% if not config.modbus.enabled %}disabled{% endif %}>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="modbus_port">Relay Port</label>
                                        <input type="number" id="modbus_port" name="modbus_port" class="form-control" value="{{ config.modbus.port|default(502) }}" min="1" max="65535" {% if not config.modbus.enabled %}disabled{% endif %}>
                                        <small>Default Modbus TCP port is 502</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="modbus_unit_id">Unit ID/Slave Address</label>
                                        <input type="number" id="modbus_unit_id" name="modbus_unit_id" class="form-control" value="{{ config.modbus.unit_id|default(1) }}" min="1" max="255" {% if not config.modbus.enabled %}disabled{% endif %}>
                                        <small>Default is 1 for most devices</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="modbus_max_channels">Number of Relay Channels</label>
                                        <select id="modbus_max_channels" name="modbus_max_channels" class="form-control" {% if not config.modbus.enabled %}disabled{% endif %}>
                                            <option value="8" {% if config.modbus.max_channels == 8 %}selected{% endif %}>8 Channels</option>
                                            <option value="16" {% if config.modbus.max_channels == 16 or not config.modbus.max_channels %}selected{% endif %}>16 Channels</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="modbus_pulse_seconds">Pulse Duration (seconds)</label>
                                        <input type="number" id="modbus_pulse_seconds" name="modbus_pulse_seconds" class="form-control" value="{{ config.modbus.pulse_seconds|default(1) }}" min="0.1" max="10" step="0.1" {% if config.modbus.follower_mode or not config.modbus.enabled %}disabled{% endif %}>
                                        <small>Duration of relay activation (0.1-10s)</small>
                                    </div>
                                </div>
                            </div>

                            <div class="custom-control custom-switch mt-2 mb-3">
                                <input type="checkbox" class="custom-control-input" id="modbus_follower_mode" name="modbus_follower_mode" {% if config.modbus.follower_mode %}checked{% endif %} {% if not config.modbus.enabled %}disabled{% endif %}>
                                <label class="custom-control-label" for="modbus_follower_mode">Enable Follower Mode</label>
                                <small class="d-block mt-1">Relay state directly follows sensor state (ON when open/alert, OFF when closed/normal)</small>
                            </div>

                            <div class="card mt-3">
                                <div class="card-body p-3">
                                    <h5 class="card-title mb-2" style="font-size: 1rem;">Test Relay Channels</h5>
                                    <div id="relay-test-buttons" class="mb-2 text-center">
                                        <!-- Relay test buttons will be generated here -->
                                    </div>
                                    <div id="relay-test-status" class="mt-2 text-center" style="min-height: 24px;"></div>

                                    <div class="mt-3 text-center">
                                        <button type="button" class="btn btn-secondary btn-sm" id="test-modbus-btn">
                                            <i class="fas fa-vial"></i> Run Modbus Tests
                                        </button>
                                        <span id="modbus-test-spinner" class="spinner hidden"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Results will appear here -->
                            <div id="modbus-test-results" class="test-result-container mt-3" style="display: none;">
                                <h5 class="mb-3">Modbus Test Results</h5>
                                <div id="modbus-test-results-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monitor & General Settings -->
                <div class="accordion-header" data-target="general-settings">
                    <h3><i class="fas fa-sliders"></i> General Settings</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="accordion-content" id="general-settings">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="monitor_api_key">Monitor API Key</label>
                                <input type="text" id="monitor_api_key" name="monitor_api_key" class="form-control" value="{{ config.monitor.api_key|default('') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="door_open_timeout">Door Open Timeout (seconds)</label>
                                <input type="number" id="door_open_timeout" name="door_open_timeout" class="form-control" value="{{ config.door_open_timeout|default(30) }}" min="1" required>
                                <small>Time before triggering an alert for a door left open</small>
                                <div class="invalid-feedback">Timeout must be at least 1 second</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary" id="save-config-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
                <span id="save-status" class="ml-2"></span>
            </div>
        </form>

        <!-- User Management Section -->
        <div class="user-management">
            <h3><i class="fas fa-users"></i> User Management</h3>
            <form id="create-user-form" class="needs-validation" method="POST" action="{{ url_for('create_user') }}" novalidate>
                <div class="row">
                    <div class="col-md-5">
                        <div class="form-group mb-md-0">
                            <label for="username">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                            <div class="invalid-feedback">Please enter a username</div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group mb-md-0">
                            <label for="password">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="8">
                            <div class="invalid-feedback">Password must be at least 8 characters</div>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>
                </div>
                <small class="mt-2"><i class="fas fa-info-circle"></i> New users will be required to change their password and set up 2FA on first login</small>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>

    <script>
        // Constants
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 3000;
        const STATUS_CHECK_INTERVAL = 15000;

        // Global variables
        let statusCheckTimer = null;

        // AJAX helper with retries
        function fetchWithRetry(url, options = {}, retries = MAX_RETRIES) {
            return new Promise((resolve, reject) => {
                function attempt(remainingRetries) {
                    console.log(`Fetching ${url}, retries remaining: ${remainingRetries}`);

                    $.ajax({
                        url: url,
                        type: options.method || 'GET',
                        data: options.data || null,
                        contentType: options.contentType || 'application/x-www-form-urlencoded',
                        dataType: options.dataType || 'json',
                        timeout: options.timeout || 15000,
                        success: function(response) {
                            resolve(response);
                        },
                        error: function(xhr, status, error) {
                            console.error(`Error fetching ${url}:`, error);

                            if (remainingRetries > 0 && (status === 'timeout' || status === 'error')) {
                                // Retry after delay
                                setTimeout(() => {
                                    attempt(remainingRetries - 1);
                                }, RETRY_DELAY);
                            } else {
                                reject(new Error(`Failed to fetch ${url}: ${error || status}`));
                            }
                        }
                    });
                }

                attempt(retries);
            });
        }

        // Show toast notification
        function showToast(title, message, type = 'success', duration = 5000) {
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div class="toast ${type}" id="${toastId}">
                    <div class="toast-header">
                        <strong class="mr-auto">${title}</strong>
                        <button type="button" class="close" data-dismiss="toast">&times;</button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            $('#toast-container').append(toastHtml);
            const $toast = $(`#${toastId}`);

            // Show the toast
            setTimeout(() => {
                $toast.addClass('show');

                // Auto-hide after duration
                setTimeout(() => {
                    $toast.removeClass('show');
                    setTimeout(() => $toast.remove(), 300);
                }, duration);
            }, 100);

            // Setup close button
            $toast.find('.close').on('click', function() {
                $toast.removeClass('show');
                setTimeout(() => $toast.remove(), 300);
            });
        }

        function updateStatus(elementId, iconId, message, success) {
            const statusIcon = $(`#${iconId}`);
            statusIcon.removeClass('error');
            statusIcon.find('i').removeClass('fa-times').removeClass('fa-check');

            if (success) {
                statusIcon.addClass('success');
                statusIcon.find('i').addClass('fa-check');
            } else {
                statusIcon.addClass('error');
                statusIcon.find('i').addClass('fa-times');
            }

            $(`#${elementId}`).text(message);
        }

        function checkAllStatuses() {
            fetchWithRetry('/check_all_statuses')
                .then(response => {
                    updateStatus('yolink-mqtt-message', 'yolink-status-icon', response.yolink.message,
                                 response.yolink.status === "success");
                    updateStatus('monitor-mqtt-message', 'monitor-status-icon', response.monitor.message,
                                 response.monitor.status === "success");
                    updateStatus('receiver-message', 'receiver-status-icon', response.receiver.message,
                                 response.receiver.status === "success");
                    updateStatus('modbus-message', 'modbus-status-icon', response.modbus.message,
                                 response.modbus.status === "success");
                })
                .catch(error => {
                    console.error("Failed to check statuses:", error);
                    updateStatus('yolink-mqtt-message', 'yolink-status-icon', 'Failed to check YoLink MQTT', false);
                    updateStatus('monitor-mqtt-message', 'monitor-status-icon', 'Failed to check Monitor MQTT', false);
                    updateStatus('receiver-message', 'receiver-status-icon', 'Failed to check Receiver', false);
                    updateStatus('modbus-message', 'modbus-status-icon', 'Failed to check Modbus relay', false);
                    showToast("Connection Error", "Failed to check system status", "error");
                });
        }

        function generateRelayTestButtons(channelCount) {
            const container = $('#relay-test-buttons');
            container.empty();

            for (let i = 1; i <= channelCount; i++) {
                container.append(`
                    <button type="button" class="btn btn-test m-1"
                            onclick="testRelayChannel(${i})">
                        ${i}
                    </button>
                `);
            }
        }

        window.testRelayChannel = function(channel) {
            const statusElement = $('#relay-test-status');
            statusElement.html(`<span class="spinner"></span> Testing channel ${channel}...`);

            fetchWithRetry('/test_relay_channel', {
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ channel: channel })
            })
            .then(response => {
                if (response.status === 'success') {
                    statusElement.html(`<span class="text-success"><i class="fas fa-check-circle"></i> ${response.message}</span>`);
                } else {
                    statusElement.html(`<span class="text-danger"><i class="fas fa-times-circle"></i> ${response.message}</span>`);
                }
            })
            .catch(error => {
                statusElement.html(`<span class="text-danger"><i class="fas fa-times-circle"></i> Error: ${error.message}</span>`);
            });
        };

        // Add visual indicators to show which is the primary receiver
        function highlightPrimaryReceiver() {
            // Remove highlight from all sections
            $('#chekt-section, #sia-section, #modbus-section').removeClass('primary-receiver');

            // Add highlight to selected primary receiver
            const receiverType = $('#receiver_type').val();
            if (receiverType === 'CHEKT') {
                $('#chekt-section').addClass('primary-receiver');
            } else if (receiverType === 'SIA') {
                $('#sia-section').addClass('primary-receiver');
            } else if (receiverType === 'MODBUS') {
                $('#modbus-section').addClass('primary-receiver');
            }
        }

        function startStatusCheck() {
            // Clear any existing timer
            if (statusCheckTimer) {
                clearInterval(statusCheckTimer);
            }

            // Set up periodic status checks
            statusCheckTimer = setInterval(checkAllStatuses, STATUS_CHECK_INTERVAL);
        }

        function stopStatusCheck() {
            if (statusCheckTimer) {
                clearInterval(statusCheckTimer);
                statusCheckTimer = null;
            }
        }

        // Test Modbus connection
        function testModbusConnection() {
            $('#modbus-test-spinner').removeClass('hidden');
            $('#test-modbus-btn').prop('disabled', true);
            $('#modbus-test-results').hide();
            $('#modbus-test-results-content').empty();

            fetchWithRetry('/test_modbus')
                .then(response => {
                    let resultsHtml = '';

                    if (response.tests && response.tests.length > 0) {
                        response.tests.forEach(test => {
                            resultsHtml += `
                                <div class="test-result-item ${test.success ? 'success' : 'error'}">
                                    <h5>${test.name}</h5>
                                    <p>${test.message}</p>
                                </div>
                            `;
                        });
                    } else {
                        resultsHtml = `
                            <div class="test-result-item ${response.status === 'success' ? 'success' : 'error'}">
                                <h5>Modbus Test</h5>
                                <p>${response.message}</p>
                            </div>
                        `;
                    }

                    $('#modbus-test-results-content').html(resultsHtml);
                    $('#modbus-test-results').show();

                    // Show toast notification
                    if (response.status === 'success') {
                        showToast('Test Successful', 'All Modbus tests passed successfully', 'success');
                    } else if (response.status === 'warning' || response.status === 'partial') {
                        showToast('Test Warning', response.message, 'warning');
                    } else {
                        showToast('Test Failed', response.message, 'error');
                    }
                })
                .catch(error => {
                    $('#modbus-test-results-content').html(`
                        <div class="test-result-item error">
                            <h5>Error Running Tests</h5>
                            <p>${error.message}</p>
                        </div>
                    `);
                    $('#modbus-test-results').show();
                    showToast('Test Error', 'Failed to run Modbus tests', 'error');
                })
                .finally(() => {
                    $('#modbus-test-spinner').addClass('hidden');
                    $('#test-modbus-btn').prop('disabled', false);
                });
        }

        // Configuration form validation
        function validateConfigForm() {
            const form = document.getElementById('config-form');
            let isValid = true;

            const numberInputs = form.querySelectorAll('input[type="number"][required]');
            numberInputs.forEach(input => {
                if (!input.value.trim() || isNaN(input.value)) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                input.classList.remove('is-invalid');
                }
            });

            if (!form.checkValidity() || !isValid) {
                event.preventDefault();
                event.stopPropagation();
                form.classList.add('was-validated');
                return false;
            }

            form.classList.add('was-validated');
            return true;
        }

        // Accordion functionality
        function setupAccordion() {
            $('.accordion-header').click(function() {
                const target = $(this).data('target');
                $(this).toggleClass('active');
                $(`#${target}`).toggleClass('active');
                $(this).find('.toggle-icon').toggleClass('rotate');
            });
        }

        $(document).ready(function() {
            // Initialize accordion
            setupAccordion();

            // Initial status check
            checkAllStatuses();
            startStatusCheck();

            // Initial highlight of primary receiver
            highlightPrimaryReceiver();

            // Generate relay test buttons
            const initialChannelCount = parseInt($('#modbus_max_channels').val()) || 16;
            if ($('#modbus_enabled').is(':checked')) {
                generateRelayTestButtons(initialChannelCount);
            }

            // Handle receiver type change
            $('#receiver_type').change(function() {
                highlightPrimaryReceiver();
            });

            // Toggle SIA fields based on SIA enabled status
            $('#sia_enabled').change(function() {
                const enabled = $(this).is(':checked');
                if (enabled) {
                    $('#sia-config').css('opacity', '1');
                    $('#sia-config input, #sia-config select').prop('disabled', false);
                } else {
                    $('#sia-config').css('opacity', '0.5');
                    $('#sia-config input, #sia-config select').prop('disabled', true);
                }
            });

            // Toggle Modbus fields based on Modbus enabled status
            $('#modbus_enabled').change(function() {
                const enabled = $(this).is(':checked');
                if (enabled) {
                    $('#modbus-config').css('opacity', '1');
                    $('#modbus-config input, #modbus-config select').prop('disabled', false);

                    // Check follower mode status
                    const followerMode = $('#modbus_follower_mode').is(':checked');
                    $('#modbus_follower_mode').prop('disabled', false);

                    if (followerMode) {
                        $('#modbus_pulse_seconds').prop('disabled', true);
                    } else {
                        $('#modbus_pulse_seconds').prop('disabled', false);
                    }
                } else {
                    $('#modbus-config').css('opacity', '0.5');
                    $('#modbus-config input, #modbus-config select').prop('disabled', true);
                }

                // If modbus is disabled, we need to regenerate test buttons
                if (enabled) {
                    const channelCount = parseInt($('#modbus_max_channels').val()) || 16;
                    generateRelayTestButtons(channelCount);
                } else {
                    // Clear test buttons
                    $('#relay-test-buttons').empty();
                }
            });

            // Toggle pulse duration section based on follower mode
            $('#modbus_follower_mode').change(function() {
                const followerMode = $(this).is(':checked');
                if (followerMode) {
                    // Disable pulse duration input in follower mode
                    $('#modbus_pulse_seconds').prop('disabled', true);
                } else {
                    // Enable pulse duration input in pulse mode
                    $('#modbus_pulse_seconds').prop('disabled', false);
                }
            });

            // Update test buttons when channel count changes
            $('#modbus_max_channels').change(function() {
                const channelCount = parseInt($(this).val()) || 16;
                generateRelayTestButtons(channelCount);
            });

            // Refresh devices button
            $('#refresh-devices-btn').click(function() {
                $('#refresh-spinner').removeClass('hidden');
                $('#refresh-message').text('Refreshing YoLink devices...');
                $('#refresh-devices-btn').prop('disabled', true);
                $('#refresh-devices-btn').html('<i class="fas fa-spinner fa-spin"></i> Refreshing...');

                fetchWithRetry('/refresh_devices', {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => {
                    $('#refresh-devices-btn').prop('disabled', false);
                    $('#refresh-devices-btn').html('<i class="fas fa-sync-alt"></i> Refresh YoLink Devices');
                    $('#refresh-spinner').addClass('hidden');

                    if (response.status === "success") {
                        $('#refresh-message').html(`<span class="text-success"><i class="fas fa-check-circle"></i> ${response.message || 'Devices refreshed successfully'}</span>`);
                        showToast("Success", "Devices refreshed successfully", "success");
                    } else {
                        $('#refresh-message').html(`<span class="text-warning"><i class="fas fa-exclamation-circle"></i> ${response.message || 'Refresh completed with warnings'}</span>`);
                        showToast("Warning", "Refresh completed with warnings", "warning");
                    }

                    // Clear the message after 5 seconds
                    setTimeout(() => {
                        $('#refresh-message').text('');
                    }, 5000);
                })
                .catch(error => {
                    $('#refresh-devices-btn').prop('disabled', false);
                    $('#refresh-devices-btn').html('<i class="fas fa-sync-alt"></i> Refresh YoLink Devices');
                    $('#refresh-spinner').addClass('hidden');

                    $('#refresh-message').html(`<span class="text-danger"><i class="fas fa-times-circle"></i> ${error.message}</span>`);
                    showToast("Error", "Failed to refresh devices", "error");

                    // Clear the message after 5 seconds
                    setTimeout(() => {
                        $('#refresh-message').text('');
                    }, 5000);
                });
            });

            // Restart services button
            $('#restart-services-btn').click(function() {
                $(this).prop('disabled', true);
                $(this).html('<i class="fas fa-spinner fa-spin"></i> Restarting...');

                fetchWithRetry('/restart_services', {
                    method: 'POST'
                })
                .then(response => {
                    if (response.status === "success") {
                        showToast("Success", "Services restarted successfully", "success");
                        // Check statuses after a delay
                        setTimeout(checkAllStatuses, 5000);
                    } else {
                        showToast("Error", "Service restart failed: " + (response.message || "Unknown error"), "error");
                    }
                })
                .catch(error => {
                    showToast("Error", "Failed to restart services: " + error.message, "error");
                })
                .finally(() => {
                    $('#restart-services-btn').prop('disabled', false);
                    $('#restart-services-btn').html('<i class="fas fa-redo"></i> Restart Services');
                });
            });

            // Test Modbus button
            $('#test-modbus-btn').click(function() {
                testModbusConnection();
            });

            // Config form submission
            $('#config-form').on('submit', function(e) {
                e.preventDefault();

                // Validate form
                if (!validateConfigForm()) {
                    showToast("Validation Error", "Please fix the errors in the form", "error");
                    return;
                }

                const formData = $(this).serialize();
                $('#save-config-btn').prop('disabled', true);
                $('#save-config-btn').html('<i class="fas fa-spinner fa-spin"></i> Saving...');
                $('#save-status').html('');

                fetchWithRetry("{{ url_for('config') }}", {
                    method: 'POST',
                    data: formData
                })
                .then(response => {
                    $('#save-status').html('<span style="color: var(--success-color);"><i class="fas fa-check-circle"></i> Saved!</span>').addClass('visible');
                    showToast("Success", "Configuration saved successfully", "success");

                    // Restart services after saving
                    return fetchWithRetry('/restart_services', {
                        method: 'POST'
                    });
                })
                .then(serviceResponse => {
                    if (serviceResponse && serviceResponse.status === "success") {
                        $('#save-status').html('<span style="color: var(--success-color);"><i class="fas fa-check-circle"></i> Saved & Services Restarted</span>');
                        // Update status after services restart
                        setTimeout(checkAllStatuses, 5000);
                    } else {
                        $('#save-status').html('<span style="color: var(--warning-color);"><i class="fas fa-exclamation-circle"></i> Saved (Service restart failed)</span>');
                    }
                })
                .catch(error => {
                    $('#save-status').html('<span style="color: var(--error-color);"><i class="fas fa-times-circle"></i> Error: ' + error.message + '</span>').addClass('visible');
                    showToast("Error", "Failed to save configuration: " + error.message, "error");
                })
                .finally(() => {
                    $('#save-config-btn').prop('disabled', false);
                    $('#save-config-btn').html('<i class="fas fa-save"></i> Save Configuration');

                    setTimeout(() => {
                        $('#save-status').removeClass('visible');
                    }, 5000);
                });
            });

            // User creation form
            $('#create-user-form').on('submit', function(e) {
                e.preventDefault();

                const form = this;
                if (form.checkValidity() === false) {
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }

                // Form is valid, submit via AJAX
                const formData = $(this).serialize();
                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true);
                submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Adding...');

                $.ajax({
                    type: 'POST',
                    url: "{{ url_for('create_user') }}",
                    data: formData,
                    success: function() {
                        showToast("Success", "User created successfully", "success");
                        form.reset();
                    },
                    error: function(xhr) {
                        showToast("Error", "Failed to create user: " + xhr.responseText, "error");
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false);
                        submitBtn.html('<i class="fas fa-user-plus"></i> Add User');
                        form.classList.remove('was-validated');
                    }
                });
            });

            // Cleanup on page unload
            $(window).on('beforeunload', function() {
                stopStatusCheck();
            });
        });
    </script>
</body>
</html>