<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YoLink to CHEKT Status</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; padding: 20px; background-color: #2e2e2e; color: #ffffff; }
        .status, .sensor-data { background-color: #4a4a4a; padding: 15px; border-radius: 10px; margin-bottom: 30px; }
        .status img { width: 20px; height: 20px; margin-right: 10px; }
        h1, h2 { color: #ffffff; }
        .sensor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .sensor { background-color: #3a3a3a; padding: 15px; border-radius: 10px; }
        .sensor-name { font-size: 1.25rem; font-weight: bold; color: #00ff00; }
        .sensor-data-item { font-size: 1rem; margin: 5px 0; }
        .battery-icon { font-size: 1.2em; margin-right: 10px; vertical-align: middle; }
        .battery-icon.fa-battery-empty { color: red; }
        .battery-icon.fa-battery-quarter { color: orange; }
        .battery-icon.fa-battery-half { color: gold; }
        .battery-icon.fa-battery-three-quarters { color: yellowgreen; }
        .battery-icon.fa-battery-full { color: green; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #ffffff; border-radius: 50%; width: 24px; height: 24px; display: inline-block; margin-left: 10px; vertical-align: middle; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .chekt-zone, .door-prop-toggle { color: red; font-size: 1.25rem; font-weight: bold; cursor: pointer; display: block; margin-top: 5px; }
        .chekt-zone-input { width: 60px; text-align: center; font-size: 1.25rem; font-weight: bold; color: red; background-color: transparent; border: none; border-bottom: 1px solid red; margin-top: 5px; }
        .door-prop-input { width: auto; margin-top: 5px; }
        .save-confirmation { color: #00ff00; font-size: 0.9rem; font-weight: bold; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">YoLink to CHEKT</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active"><a class="nav-link" href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('config') }}">Configuration</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
            </ul>
        </div>
    </nav>

    {% if current_user.is_authenticated %}
    <div class="container">
        <h1>Welcome, {{ current_user.id }}!</h1>
        <div class="status">
            <h2>Status <span class="spinner"></span></h2>
            <div id="yolink-mqtt-status" class="status-item mb-2">
                <img src="" alt="YoLink MQTT Status" id="yolink-mqtt-icon" class="hidden">
                <span id="yolink-mqtt-message">Checking YoLink MQTT connection...</span>
            </div>
            <div id="monitor-mqtt-status" class="status-item mb-2">
                <img src="" alt="Monitor MQTT Status" id="monitor-mqtt-icon" class="hidden">
                <span id="monitor-mqtt-message">Checking Monitor MQTT connection...</span>
            </div>
            <div id="receiver-status" class="status-item mb-2">
                <img src="" alt="Receiver Status" id="receiver-icon" class="hidden">
                <span id="receiver-message">Checking Receiver status...</span>
            </div>
            <button id="update-devices" class="btn btn-secondary mt-3">Update YoLink Devices</button>
        </div>

        <div class="sensor-data">
            <h2>Sensor Data</h2>
            <div class="sensor-grid" id="sensor-list">
                {% for device in devices %}
                <div class="sensor">
                    <p class="sensor-name">{{ device.name or 'Unknown Device' }}</p>
                    <span class="chekt-zone" onclick="makeZoneEditable(this, '{{ device.deviceId }}')">{{ device.chekt_zone if device.chekt_zone != 'N/A' else 'No Zone' }}</span>
                    {% if device.type == 'door' %}
                    <span class="door-prop-toggle" onclick="makeDoorPropEditable(this, '{{ device.deviceId }}')">{{ 'Enabled' if device.door_prop_alarm else 'Disabled' }}</span>
                    {% endif %}
                    {% if device.state and device.state != 'unknown' %}<p class="sensor-data-item">State: {{ device.state }}</p>{% endif %}
                    {% if device.battery is not none %}
                    <p class="sensor-data-item">
                        <i class="fas {{ 'fa-battery-full' if device.battery == 4 else 'fa-battery-three-quarters' if device.battery == 3 else 'fa-battery-half' if device.battery == 2 else 'fa-battery-quarter' if device.battery == 1 else 'fa-battery-empty' }} battery-icon"></i>
                        Battery: {{ device.battery }}
                    </p>
                    {% endif %}
                    {% if device.last_seen %}<p class="sensor-data-item">Last Seen: {{ device.last_seen }}</p>{% endif %}
                    {% if device.alarms and device.alarms.state %}<p class="sensor-data-item" style="color: red;">Alarm: {{ device.alarms.state }}</p>{% endif %}
                    <span class="save-confirmation" id="save-confirmation-{{ device.deviceId }}" style="display: none;">Saved!</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <script>window.location.href = "{{ url_for('login') }}";</script>
    {% endif %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script>
        function updateStatus(elementId, iconId, message, success) {
            const icon = success ? 'https://img.icons8.com/color/48/000000/checkmark.png' : 'https://img.icons8.com/color/48/000000/cancel.png';
            $('#' + iconId).attr('src', icon).removeClass('hidden');
            $('#' + elementId).text(message);
        }

        function checkStatus(url, elementId, iconId, successMessage, errorMessage) {
            $.get(url, function(response) {
                updateStatus(elementId, iconId, response.message, response.status === "success");
            }).fail(function() {
                updateStatus(elementId, iconId, errorMessage, false);
            });
        }

        function makeZoneEditable(zoneSpan, deviceId) {
            const currentZone = zoneSpan.textContent.replace('No Zone', '').trim();
            const input = $('<input type="text" class="chekt-zone-input">').val(currentZone);
            $(zoneSpan).hide().after(input);
            input.focus();

            function saveZone() {
                const newZone = input.val().trim();
                $.post('/save_mapping', { yolink_device_id: deviceId, chekt_zone: newZone }, function(response) {
                    if (response.status === 'success') {
                        $(zoneSpan).text(newZone || 'No Zone').show();
                        input.remove();
                        $('#save-confirmation-' + deviceId).show().delay(2000).fadeOut();
                    }
                });
            }

            input.on('blur', saveZone).on('keypress', function(e) {
                if (e.which == 13) saveZone();
            });
        }

        function makeDoorPropEditable(toggleSpan, deviceId) {
            const currentState = toggleSpan.textContent === 'Enabled';
            const input = $('<input type="checkbox" class="door-prop-input">').prop('checked', currentState);
            $(toggleSpan).hide().after(input);
            input.focus();

            function saveDoorProp() {
                const enabled = input.prop('checked');
                $.post('/set_door_prop_alarm', { device_id: deviceId, enabled: enabled }, function(response) {
                    if (response.status === 'success') {
                        $(toggleSpan).text(enabled ? 'Enabled' : 'Disabled').show();
                        input.remove();
                        $('#save-confirmation-' + deviceId).show().delay(2000).fadeOut();
                    }
                });
            }

            input.on('change', saveDoorProp);
        }

        function refreshDashboard() {
            $.get('/').then(function(data) {
                $('#sensor-list').html($(data).find('#sensor-list').html());
            });
        }

        $(document).ready(function() {
            checkStatus('/check_mqtt_status', 'yolink-mqtt-message', 'yolink-mqtt-icon', 'YoLink MQTT connection is active.', 'YoLink MQTT connection is inactive.');
            checkStatus('/check_monitor_mqtt_status', 'monitor-mqtt-message', 'monitor-mqtt-icon', 'Monitor MQTT connection is active.', 'Monitor MQTT connection is inactive.');
            checkStatus('/check_receiver_status', 'receiver-message', 'receiver-icon', 'Receiver is alive.', 'Receiver connection failed.');

            setInterval(refreshDashboard, 5000);  // Auto-refresh every 5 seconds

            $('#update-devices').click(function() {
                $.get('/refresh_devices', function(response) {  // Updated to /refresh_devices
                    updateStatus('refresh-message', 'refresh-icon', response.message, response.status === "success");
                    location.reload();
                });
            });
        });
    </script>
</body>
</html>