<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yolink to CHEKT Configuration</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f8f8f8;
        }

        .log {
            background-color: #f1f1f1;
            padding: 15px;
            margin-top: 20px;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Yolink to CHEKT Mapping</h1>

        <!-- Test Yolink API -->
        <div class="mb-3">
            <button type="button" id="test-yolink-btn" class="btn btn-primary">Test Yolink API Connection</button>
            <div id="yolink-status"></div>
        </div>

        <!-- Test CHEKT API -->
        <div class="mb-3">
            <button type="button" id="test-chekt-btn" class="btn btn-secondary">Test CHEKT API Connection</button>
            <div id="chekt-status"></div>
        </div>

        <!-- Load Homes -->
        <div class="mb-3">
            <button type="button" id="load-homes-btn" class="btn btn-info">Load Homes</button>
            <select id="home-select" class="form-select mt-3">
                <option value="">Select a home...</option>
            </select>
            <button type="button" id="load-devices-btn" class="btn btn-success mt-3">Load Devices for Selected Home</button>
        </div>

        <!-- Log Area -->
        <div id="log-area" class="log"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function addToLog(message) {
            $('#log-area').append('<div>' + new Date().toLocaleString() + ': ' + message + '</div>');
            $('#log-area').scrollTop($('#log-area')[0].scrollHeight);
        }

        function refreshLogs() {
            $.ajax({
                type: "GET",
                url: "/get_logs",
                success: function(response) {
                    if (response.logs) {
                        $('#log-area').empty();
                        response.logs.forEach(function(log) {
                            addToLog(log);
                        });
                    }
                },
                error: function(xhr, status, error) {
                    addToLog('Error fetching logs: ' + xhr.responseText);
                }
            });
        }

        // Test Yolink API
        $('#test-yolink-btn').on('click', function() {
            $.ajax({
                type: "GET",
                url: "/test_yolink_api",
                success: function(response) {
                    if (response.status === "success") {
                        addToLog("Yolink API connection successful.");
                    } else {
                        addToLog("Failed to connect to Yolink API: " + response.message);
                    }
                    refreshLogs();
                },
                error: function(xhr, status, error) {
                    addToLog('Error connecting to Yolink API: ' + xhr.responseText);
                    addToLog('Debug Status: ' + status + ', Error: ' + error);
                    refreshLogs();
                }
            });
        });

        // Test CHEKT API
        $('#test-chekt-btn').on('click', function() {
            $.ajax({
                type: "GET",
                url: "/test_chekt_api",
                success: function(response) {
                    if (response.status === "success") {
                        addToLog("CHEKT API connection successful.");
                    } else {
                        addToLog("Failed to connect to CHEKT API: " + response.message);
                    }
                    refreshLogs();
                },
                error: function(xhr, status, error) {
                    addToLog('Error connecting to CHEKT API: ' + xhr.responseText);
                    addToLog('Debug Status: ' + status + ', Error: ' + error);
                    refreshLogs();
                }
            });
        });

        // Load Homes
        $('#load-homes-btn').on('click', function() {
            $.ajax({
                type: "GET",
                url: "/get_homes",
                success: function(response) {
                    if (response.status === "success") {
                        let homes = response.homes;
                        $('#home-select').empty().append('<option value="">Select a home...</option>');
                        homes.forEach(function(home) {
                            $('#home-select').append('<option value="' + home.id + '">' + home.name + '</option>');
                        });
                        addToLog("Homes loaded successfully.");
                    } else {
                        addToLog("Failed to load homes: " + response.message);
                    }
                    refreshLogs();
                },
                error: function(xhr, status, error) {
                    addToLog('Error loading homes: ' + xhr.responseText);
                    refreshLogs();
                }
            });
        });

        // Load Devices for Selected Home
        $('#load-devices-btn').on('click', function() {
            const homeId = $('#home-select').val();
            if (!homeId) {
                addToLog("Please select a home.");
                return;
            }

            $.ajax({
                type: "POST",
                url: "/get_devices",
                contentType: "application/json",
                data: JSON.stringify({ "home_id": homeId }),
                success: function(response) {
                    if (Array.isArray(response) && response.length > 0) {
                        addToLog('Devices loaded successfully for selected home.');
                    } else {
                        addToLog('No devices found for selected home.');
                    }
                    refreshLogs();
                },
                error: function(xhr, status, error) {
                    addToLog('Error loading devices: ' + xhr.responseText);
                    refreshLogs();
                }
            });
        });

        // Refresh logs every 5 seconds
        setInterval(refreshLogs, 5000);
    </script>
</body>

</html>
